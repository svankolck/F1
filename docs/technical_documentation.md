# F1 App 2026 ‚Äî Technical Documentation

This document outlines the technical architecture, data flow, API integrations, and security mechanisms of the F1 web application.

---

## üèéÔ∏è 1. Overview & Tech Stack

A full-stack Next.js application designed to provide F1 fans with live timing, historical results, driver standings, and an interactive prediction game. 

**Core Stack:**
- **Framework:** Next.js 14+ (App Router, Server Actions)
- **Language:** TypeScript
- **Styling:** Tailwind CSS + custom glassmorphism components
- **Database & Auth:** Supabase (PostgreSQL)
- **Deployment:** Vercel

**External F1 APIs:**
- **Jolpica F1 API** (Ergast replacement): Used for historical data, race schedules, and official classifying results.
- **OpenF1 API:** Used for live, real-time telemetry, pit stops, and race control messages.

---

## üèõÔ∏è 2. Application Architecture

The app uses the Next.js App Router paradigm, strictly separating Server Components (fastest load, SEO, direct DB access) from Client Components (interactivity, live polling).

### Directory Structure
- `/app/` ‚Äî Next.js routing, Server Components, and API endpoints (`/api/...`).
- `/components/` ‚Äî Reusable React Client Components organized by feature (`/game`, `/standings`, `/timing`, `/auth`).
- `/lib/api/` ‚Äî Typed wrapper functions for external F1 APIs (`jolpica.ts`, `openf1.ts`, `game.ts`).
- `/lib/types/` ‚Äî Shared TypeScript interfaces and UI constants (e.g., TEAM_COLORS, DRIVER_IMAGE_MAP).
- `/lib/supabase/` ‚Äî Supabase clients (`server.ts`, `client.ts`, `admin.ts`).
- `/supabase/migrations/` ‚Äî Verifiable SQL migrations defining the database schema and Row Level Security (RLS).

### API Route Design
To prevent client-side secrets exposure and CORS issues, the app routes external traffic through its own Next.js API ecosystem:
- `/api/timing` ‚Äî Proxies and merges OpenF1 live data.
- `/api/game/predictions` ‚Äî Secure POST endpoint to save user predictions.
- `/api/game/calculate` ‚Äî Protected admin endpoint to tally points after a race.

---

## üìä 3. Database Schema (Supabase)

Data is stored in Supabase PostgreSQL across three primary tables and one secure view:

#### `profiles`
Stores user settings and default game strategies.
- `id` (uuid, PK, references `auth.users`)
- `username`, `first_name`, `last_name`, `avatar_url`
- `default_pole_driver`, `default_p1_driver`, `default_p2_driver`, `default_p3_driver`

#### `predictions`
Stores individual race/sprint predictions tied to specific rounds.
- `id` (uuid, PK)
- `user_id` (uuid, FK)
- `season` (int), `round` (int), `session_type` ('race' | 'sprint')
- `pole_driver_id`, `p1_driver_id`, `p2_driver_id`, `p3_driver_id`
- *Constraints:* Drivers cannot be duplicated within a single prediction slot configuration.

#### `game_scores`
Stores the calculated results generated by the admin engine.
- `id` (uuid, PK)
- `user_id` (uuid, FK)
- `season`, `round`, `session_type`
- `pole_points`, `p1_points`, `p2_points`, `p3_points`, `bonus_points`, `total_points`

#### `public_profiles` (View)
A secure SQL View representing the `profiles` table but stripping all PII (first name, last name, avatar) and game strategy. Exposes only `id` and `username` for rendering leaderboards.

---

## üéÆ 4. Game Engine & Prediction Logic

The prediction game revolves around picking the top drivers for a specific Grand Prix or Sprint.

### Timelocks
Sessions are automatically locked based on the official start time fetched from Jolpica. Users can edit predictions until `startTime`.

### Fallbacks (Default Drivers)
If a user forgets to submit a prediction for a specific round, the admin calculation engine will fallback to the default drivers stored in their `profiles` row.

### Scoring Logic
Points are awarded via `/api/game/calculate` (authorized via service_role):
- **Pole Position:** Correct driver = X points
- **Podium Spots (P1, P2, P3):** Correct driver in correct exact slot = Y points
- **Bonus:** Correct driver on the podium, but in the wrong slot = Z points

---

## üì° 5. External Integrations

### Jolpica Integration (`lib/api/jolpica.ts`)
- **Use Cases:** Retrieving the 2026 season calendar, past season standings, constructor battles, and official race classifications.
- **Caching:** Standard Next.js `fetch` caching with specific `revalidate` times (e.g., 24 hours for schedules, 1 hour for standings).

### OpenF1 Integration (`lib/api/openf1.ts`)
- **Use Cases:** Live Timing dashboard during race weekends.
- **Features:** 
  - Dynamic session detection (Practice vs Quali vs Race).
  - Race control broadcasting (flags, penalties, safety cars) via `/race_control`.
  - Pit stop counters aggregated per driver via `/pit`.
  - Live telemetry gap/interval times.
- **Replay Mode:** If no session is currently live, the API falls back to the most recent completed race to showcase the timing dashboard functionality.

---

## üîê 6. Security & RLS (Row Level Security)

Security strictly follows a Server-side Validation + Database RLS paradigm.

**Database Hardening (`008_security_hardening.sql`)**
1. **Anon access revoked:** Anonymous (unlogged) users cannot read `profiles` or `predictions` via the Supabase REST API.
2. **Owner-only profiles:** `profiles` SELECT/UPDATE policies use `USING (auth.uid() = id)`. Users cannot view real names or default strategies of other players.
3. **Owner-only predictions:** `predictions` SELECT policy uses `USING (auth.uid() = user_id)`. Opponents cannot steal/copy predictions before a race begins.
4. **Service-role writes:** Inserting `predictions` and upserting `game_scores` is fully locked down in the database. Client apps **cannot** write directly. They must use the Next.js API routes (`/api/game/...`) which validate session context before using the admin `SUPABASE_SERVICE_ROLE_KEY`.

**Environment Variables**
- `NEXT_PUBLIC_SUPABASE_URL` / `ANON_KEY` ‚Äî Exported to the client.
- `SUPABASE_SERVICE_ROLE_KEY` ‚Äî Strictly server-side secret for administrative database bypass actions.
